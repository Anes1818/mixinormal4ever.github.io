<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PartyHub | مشاهدة جماعية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8a2be2;
            --primary-light: #9d4edd;
            --secondary: #ff00ff;
            --accent: #00ccff;
            --accent-light: #5ce1e6;
            --dark: #0a0a14;
            --darker: #070710;
            --dark-card: #12121f;
            --light: #ffffff;
            --light-gray: #a0a0b0;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-heavy: rgba(0, 0, 0, 0.3);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-border-heavy: rgba(255, 255, 255, 0.05);
            --neon-glow: 0 0 15px var(--primary), 0 0 25px rgba(138, 43, 226, 0.5);
            --neon-glow-accent: 0 0 15px var(--accent), 0 0 25px rgba(0, 204, 255, 0.3);
            --neon-glow-secondary: 0 0 15px var(--secondary), 0 0 25px rgba(255, 0, 255, 0.3);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            --radius: 16px;
            --radius-sm: 12px;
            --radius-lg: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--darker);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(138, 43, 226, 0.1) 0%, transparent 30%),
                radial-gradient(circle at 80% 70%, rgba(0, 204, 255, 0.1) 0%, transparent 30%),
                radial-gradient(circle at 40% 80%, rgba(255, 0, 255, 0.1) 0%, transparent 30%);
        }

        /* Scrollbar Customization */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--primary-light), var(--secondary));
        }

        /* Container */
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            height: 100vh;
            gap: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--neon-glow);
            position: relative;
            overflow: hidden;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-text h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            font-size: 14px;
            color: var(--light-gray);
            font-weight: 300;
        }

        /* Room Info */
        .room-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-count {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--glass);
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }

        .user-count i {
            color: var(--accent);
        }

        .user-count span {
            font-weight: 600;
            font-size: 18px;
            color: var(--accent-light);
        }

        .room-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .icon-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--neon-glow);
        }

        /* Video Input Section */
        .video-input-section {
            position: relative;
            margin-bottom: 20px;
        }

        .video-input-container {
            display: flex;
            gap: 15px;
            position: relative;
            z-index: 2;
        }

        .video-input-wrapper {
            flex: 1;
            position: relative;
        }

        .video-input {
            width: 100%;
            padding: 18px 20px;
            padding-right: 50px;
            background: var(--glass-heavy);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius);
            color: var(--light);
            font-size: 16px;
            backdrop-filter: blur(15px);
            transition: all 0.3s ease;
        }

        .video-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--neon-glow);
            background: rgba(0, 0, 0, 0.4);
        }

        .video-input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-gray);
        }

        .btn {
            padding: 0 30px;
            height: 55px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: var(--radius);
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--neon-glow-secondary);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            gap: 25px;
            overflow: hidden;
            position: relative;
        }

        /* Video Section */
        .video-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            flex: 1;
            min-height: 400px;
            border: 1px solid var(--glass-border-heavy);
        }

        #player {
            width: 100%;
            height: 100%;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--dark), var(--darker));
            color: var(--light-gray);
            gap: 20px;
        }

        .video-placeholder i {
            font-size: 64px;
            color: var(--glass-border);
        }

        .video-placeholder p {
            font-size: 18px;
        }

        /* Video Controls */
        .video-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--glass-heavy);
            padding: 15px 25px;
            border-radius: var(--radius);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            gap: 15px;
        }

        .control-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--dark-card);
            border: 1px solid var(--glass-border);
            color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .control-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
            box-shadow: var(--neon-glow);
        }

        .control-btn.active {
            background: var(--primary);
            box-shadow: var(--neon-glow);
        }

        .time-display {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: var(--accent-light);
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .time-separator {
            color: var(--light-gray);
        }

        /* Chat Section */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--glass-heavy);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 350px;
            max-width: 450px;
            box-shadow: var(--shadow);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid var(--glass-border);
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 18px;
        }

        .chat-title i {
            color: var(--accent);
            font-size: 20px;
        }

        .chat-stats {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: var(--light-gray);
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .chat-toggle {
            background: none;
            border: none;
            color: var(--light);
            font-size: 18px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chat-toggle:hover {
            background: var(--glass);
            color: var(--accent);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: messageIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            word-wrap: break-word;
            line-height: 1.4;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-bottom-right-radius: 5px;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.3);
        }

        .message.received {
            align-self: flex-start;
            background: var(--dark-card);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--glass-border);
        }

        .message-system {
            align-self: center;
            background: var(--glass);
            color: var(--light-gray);
            font-size: 13px;
            padding: 8px 16px;
            border-radius: 20px;
            max-width: 80%;
            text-align: center;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-sender {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-light);
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .message-text {
            font-size: 14.5px;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            background: var(--dark-card);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            color: var(--light);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--neon-glow-accent);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--neon-glow-accent);
        }

        .send-btn:active {
            transform: scale(1.05);
        }

        /* Chat Minimized State */
        .chat-section.minimized {
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            overflow: hidden;
            border-radius: 35px;
        }

        .chat-section.minimized .chat-header,
        .chat-section.minimized .chat-messages,
        .chat-section.minimized .chat-input-container {
            display: none;
        }

        .chat-section.minimized .chat-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
        }

        .chat-minimized-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            position: relative;
            margin: auto;
            box-shadow: var(--neon-glow);
            transition: all 0.3s ease;
        }

        .chat-minimized-icon:hover {
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            min-width: 22px;
            height: 22px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            padding: 0 6px;
            box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        /* Party History */
        .party-history-section {
            margin-top: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
        }

        .section-title i {
            color: var(--secondary);
        }

        .clear-history {
            background: none;
            border: 1px solid var(--glass-border);
            color: var(--light-gray);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .clear-history:hover {
            background: rgba(255, 0, 255, 0.1);
            color: var(--secondary);
            border-color: var(--secondary);
        }

        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .history-card {
            background: var(--dark-card);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .history-card:hover {
            transform: translateY(-8px);
            border-color: var(--primary);
            box-shadow: var(--neon-glow);
        }

        .history-thumbnail {
            width: 100%;
            height: 140px;
            object-fit: cover;
            display: block;
        }

        .history-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 140px;
            background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.7));
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .history-card:hover .history-overlay {
            opacity: 1;
        }

        .play-overlay {
            width: 50px;
            height: 50px;
            background: rgba(138, 43, 226, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .history-info {
            padding: 15px;
        }

        .history-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }

        .history-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--light-gray);
        }

        .empty-history {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--light-gray);
        }

        .empty-history i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Theater Mode & Fullscreen */
        body.theater-mode .video-section {
            flex: 1;
        }

        body.theater-mode .chat-section {
            max-width: 400px;
        }

        body.fullscreen-video {
            overflow: hidden;
            padding: 0;
        }

        body.fullscreen-video .container {
            padding: 0;
            height: 100vh;
            max-width: 100%;
        }

        body.fullscreen-video .header,
        body.fullscreen-video .video-input-section,
        body.fullscreen-video .party-history-section {
            display: none;
        }

        body.fullscreen-video .main-content {
            height: 100vh;
            gap: 0;
        }

        body.fullscreen-video .video-section {
            flex: 1;
            border-radius: 0;
        }

        body.fullscreen-video .video-container {
            border-radius: 0;
            border: none;
        }

        body.fullscreen-video .chat-section {
            height: 100vh;
            border-radius: 0;
            border-left: 1px solid var(--glass-border);
        }

        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 20px;
            color: var(--accent);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: var(--dark-card);
            border-left: 4px solid var(--primary);
            border-radius: var(--radius-sm);
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast i {
            color: var(--primary);
            font-size: 18px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .toast-message {
            font-size: 14px;
            color: var(--light-gray);
        }

        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastOut {
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .chat-section {
                min-width: 320px;
                max-width: 380px;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .chat-section {
                max-width: 100%;
                height: 350px;
            }
            
            .chat-section.minimized {
                width: 60px;
                height: 60px;
                position: fixed;
                bottom: 20px;
                left: 20px;
                z-index: 1000;
            }
            
            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .room-info {
                width: 100%;
                justify-content: center;
            }
            
            .video-input-container {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .video-controls {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }
            
            .control-left {
                width: 100%;
                justify-content: center;
            }
            
            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
        }

        @media (max-width: 576px) {
            .logo {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .logo-text h1 {
                font-size: 24px;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .toast-container {
                bottom: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
            }
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--dark-card);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            font-size: 14px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff00;
            animation: pulse 2s infinite;
        }

        .connection-dot.disconnected {
            background: #ff4757;
        }

        /* Welcome Modal */
        .welcome-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 20, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(20px);
        }

        .welcome-content {
            background: var(--dark-card);
            border-radius: var(--radius-lg);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .welcome-icon {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 28px;
            margin-bottom: 15px;
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .welcome-text {
            color: var(--light-gray);
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--glass);
            border-radius: var(--radius-sm);
            font-size: 14px;
        }

        .feature i {
            color: var(--accent);
        }

        .start-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 16px 40px;
            border-radius: var(--radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--neon-glow);
        }

        /* Sync Indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--dark-card);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            z-index: 999;
            animation: slideInLeft 0.3s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sync-indicator i {
            color: var(--accent);
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--light-gray);
            font-size: 13px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <div class="connection-dot" id="connectionDot"></div>
        <span>متصل</span>
    </div>

    <!-- Welcome Modal -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <div class="welcome-icon">
                <i class="fas fa-film"></i>
            </div>
            <h2 class="welcome-title">مرحباً في PartyHub</h2>
            <p class="welcome-text">
                استمتع بمشاهدة فيديوهات YouTube مع أصدقائك في وقت واحد مع دردشة مباشرة ومزامنة تامة.
            </p>
            <div class="welcome-features">
                <div class="feature">
                    <i class="fas fa-sync-alt"></i>
                    <span>مزامنة تامة</span>
                </div>
                <div class="feature">
                    <i class="fas fa-comments"></i>
                    <span>دردشة مباشرة</span>
                </div>
                <div class="feature">
                    <i class="fas fa-history"></i>
                    <span>سجل المشاهدات</span>
                </div>
                <div class="feature">
                    <i class="fas fa-users"></i>
                    <span>مشاهدة جماعية</span>
                </div>
            </div>
            <button class="start-btn" id="startBtn">
                <i class="fas fa-play"></i>
                ابدأ المشاهدة
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Sync Indicator -->
    <div class="sync-indicator" id="syncIndicator" style="display: none;">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>جاري المزامنة...</span>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-film"></i>
                </div>
                <div class="logo-text">
                    <h1>PartyHub</h1>
                    <span>مشاهدة فيديو جماعية متزامنة</span>
                </div>
            </a>
            <div class="room-info">
                <div class="user-count">
                    <i class="fas fa-users"></i>
                    <span id="userCount">1</span>
                    <span>متصل</span>
                </div>
                <div class="room-actions">
                    <button class="icon-btn" id="inviteBtn" title="دعوة أصدقاء">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button class="icon-btn" id="settingsBtn" title="الإعدادات">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Input Section -->
        <div class="video-input-section">
            <div class="video-input-container">
                <div class="video-input-wrapper">
                    <input type="text" class="video-input" id="videoUrl" 
                           placeholder="أدخل رابط فيديو YouTube أو رابط مشاركة...">
                    <div class="video-input-icon">
                        <i class="fab fa-youtube"></i>
                    </div>
                </div>
                <button class="btn" id="loadVideoBtn">
                    <i class="fas fa-play-circle"></i>
                    تشغيل الفيديو
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Video Section -->
            <div class="video-section">
                <div class="video-container">
                    <div id="player"></div>
                    <div class="video-placeholder" id="videoPlaceholder">
                        <i class="fas fa-video-slash"></i>
                        <p>أدخل رابط فيديو YouTube لبدء المشاهدة</p>
                    </div>
                </div>
                <div class="video-controls">
                    <div class="control-left">
                        <button class="control-btn" id="playPauseBtn" title="تشغيل / إيقاف">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="control-btn" id="fullscreenBtn" title="ملء الشاشة">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="control-btn" id="theaterBtn" title="وضع المسرح">
                            <i class="fas fa-theater-masks"></i>
                        </button>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">00:00</span>
                        <span class="time-separator">/</span>
                        <span id="duration">00:00</span>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="chat-section" id="chatSection">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-comments"></i>
                        <span>الدردشة المباشرة</span>
                        <div class="chat-stats">
                            (<span id="messageCount">0</span> رسالة)
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-toggle" id="clearChatBtn" title="مسح الدردشة">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="chat-toggle" id="chatToggle" title="تصغير الدردشة">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message-system">
                        <i class="fas fa-info-circle"></i>
                        مرحباً! يمكنك البدء في الدردشة مع المشاهدين الآخرين.
                    </div>
                </div>
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <input type="text" class="chat-input" id="chatInput" 
                               placeholder="اكتب رسالتك هنا...">
                        <button class="send-btn" id="sendBtn" title="إرسال">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Party History Section -->
        <div class="party-history-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-history"></i>
                    <span>فيديوهات الحفلة السابقة</span>
                </h3>
                <button class="clear-history" id="clearHistoryBtn">
                    <i class="fas fa-trash"></i>
                    مسح السجل
                </button>
            </div>
            <div class="history-grid" id="historyGrid">
                <!-- سيتم تعبئتها ديناميكيًا -->
            </div>
        </div>
    </div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <!-- Application Script -->
    <script>
        // ============================================
        // Firebase Configuration - استخدم معلوماتك
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAJvohW3m1-sZAlrTjkv7UZqTLC6WigePo",
            authDomain: "party-dfe30.firebaseapp.com",
            projectId: "party-dfe30",
            storageBucket: "party-dfe30.firebasestorage.app",
            messagingSenderId: "783983668260",
            appId: "1:783983668260:web:e353a1220e7621bbf53cb1",
            measurementId: "G-60ESCD9YF1"
        };

        // ============================================
        // تهيئة التطبيق
        // ============================================
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // متغيرات التطبيق
        let player = null;
        let currentUser = null;
        let currentRoom = null;
        let videoStateRef = null;
        let chatRef = null;
        let historyRef = null;
        let usersRef = null;
        let userListener = null;
        let chatListener = null;
        let videoListener = null;
        let isChatMinimized = false;
        let isFullscreen = false;
        let isTheaterMode = false;
        let currentVideoId = null;
        let chatUnreadCount = 0;
        let lastSyncTime = Date.now();
        let isSyncing = false;
        let userTypingTimeout = null;

        // متغيرات المزامنة
        const SYNC_THRESHOLD = 2000; // 2 ثانية
        const SYNC_INTERVAL = 1000; // تحديث كل ثانية
        const TYPING_TIMEOUT = 3000; // 3 ثواني لإخفاء مؤشر الكتابة

        // ============================================
        // DOM Elements
        // ============================================
        const domElements = {
            // العناصر الأساسية
            welcomeModal: document.getElementById('welcomeModal'),
            startBtn: document.getElementById('startBtn'),
            connectionStatus: document.getElementById('connectionStatus'),
            connectionDot: document.getElementById('connectionDot'),
            toastContainer: document.getElementById('toastContainer'),
            syncIndicator: document.getElementById('syncIndicator'),
            
            // عناصر الفيديو
            videoUrl: document.getElementById('videoUrl'),
            loadVideoBtn: document.getElementById('loadVideoBtn'),
            videoPlaceholder: document.getElementById('videoPlaceholder'),
            player: document.getElementById('player'),
            playPauseBtn: document.getElementById('playPauseBtn'),
            fullscreenBtn: document.getElementById('fullscreenBtn'),
            theaterBtn: document.getElementById('theaterBtn'),
            currentTime: document.getElementById('currentTime'),
            duration: document.getElementById('duration'),
            
            // عناصر الدردشة
            chatSection: document.getElementById('chatSection'),
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendBtn: document.getElementById('sendBtn'),
            chatToggle: document.getElementById('chatToggle'),
            clearChatBtn: document.getElementById('clearChatBtn'),
            messageCount: document.getElementById('messageCount'),
            
            // المستخدمون والتاريخ
            userCount: document.getElementById('userCount'),
            historyGrid: document.getElementById('historyGrid'),
            clearHistoryBtn: document.getElementById('clearHistoryBtn'),
            
            // الأزرار الإضافية
            inviteBtn: document.getElementById('inviteBtn'),
            settingsBtn: document.getElementById('settingsBtn')
        };

        // ============================================
        // Event Listeners
        // ============================================
        function setupEventListeners() {
            // زر البدء
            domElements.startBtn.addEventListener('click', hideWelcomeModal);
            
            // تحميل الفيديو
            domElements.loadVideoBtn.addEventListener('click', loadVideoFromInput);
            domElements.videoUrl.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadVideoFromInput();
            });
            
            // عناصر التحكم بالفيديو
            domElements.playPauseBtn.addEventListener('click', togglePlayPause);
            domElements.fullscreenBtn.addEventListener('click', toggleFullscreen);
            domElements.theaterBtn.addEventListener('click', toggleTheaterMode);
            
            // الدردشة
            domElements.sendBtn.addEventListener('click', sendMessage);
            domElements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            domElements.chatInput.addEventListener('input', handleTyping);
            domElements.chatToggle.addEventListener('click', toggleChat);
            domElements.clearChatBtn.addEventListener('click', clearChat);
            
            // التاريخ
            domElements.clearHistoryBtn.addEventListener('click', clearHistory);
            
            // الأزرار الإضافية
            domElements.inviteBtn.addEventListener('click', inviteFriends);
            domElements.settingsBtn.addEventListener('click', showSettings);
            
            // أحداث المتصفح
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('keydown', handleKeyPress);
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // الاستماع لتغيرات الاتصال
            firebase.firestore().enableNetwork()
                .then(() => {
                    updateConnectionStatus(true);
                })
                .catch(() => {
                    updateConnectionStatus(false);
                });
        }

        // ============================================
        // إدارة الاتصال
        // ============================================
        function updateConnectionStatus(isConnected) {
            const status = domElements.connectionStatus;
            const dot = domElements.connectionDot;
            
            if (isConnected) {
                status.style.opacity = '0.7';
                dot.classList.remove('disconnected');
                dot.style.background = '#00ff00';
            } else {
                status.style.opacity = '1';
                dot.classList.add('disconnected');
                dot.style.background = '#ff4757';
                showToast('فقدت الاتصال بالخادم', 'error');
            }
        }

        // ============================================
        // واجهة المستخدم - Modal
        // ============================================
        function hideWelcomeModal() {
            domElements.welcomeModal.style.opacity = '0';
            domElements.welcomeModal.style.pointerEvents = 'none';
            domElements.welcomeModal.style.transition = 'opacity 0.5s ease';
            
            setTimeout(() => {
                domElements.welcomeModal.style.display = 'none';
                initializeApp();
            }, 500);
        }

        // ============================================
        // إشعارات Toast
        // ============================================
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = domElements.toastContainer;
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let icon = 'info-circle';
            let title = 'معلومة';
            
            switch(type) {
                case 'success':
                    icon = 'check-circle';
                    title = 'تم بنجاح';
                    toast.style.borderLeftColor = '#00ff00';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    title = 'خطأ';
                    toast.style.borderLeftColor = '#ff4757';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    title = 'تحذير';
                    toast.style.borderLeftColor = '#ffaa00';
                    break;
            }
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // إزالة Toast بعد المدة المحددة
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'toastOut 0.3s ease forwards';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, duration);
        }

        // ============================================
        // تهيئة التطبيق الرئيسية
        // ============================================
        function initializeApp() {
            // تسجيل الدخول كضيف
            auth.signInAnonymously()
                .then(() => {
                    currentUser = auth.currentUser;
                    currentRoom = 'main_party_room';
                    
                    showToast(`مرحباً! تم تسجيل دخولك كـ ${currentUser.uid.substring(0, 8)}`, 'success');
                    
                    // إنشاء مراجع Firestore
                    initializeFirestoreReferences();
                    
                    // تحميل مشغل YouTube
                    loadYouTubePlayer();
                    
                    // تعقب المستخدمين المتصلين
                    trackOnlineUsers();
                    
                    // الاستماع لتغييرات الفيديو
                    listenToVideoState();
                    
                    // الاستماع للدردشة
                    listenToChat();
                    
                    // تحميل سجل الفيديوهات
                    loadPartyHistory();
                })
                .catch((error) => {
                    console.error('خطأ في تسجيل الدخول:', error);
                    showToast('فشل الاتصال بالخادم. جاري إعادة المحاولة...', 'error');
                    setTimeout(initializeApp, 3000);
                });
        }

        // ============================================
        // تهيئة مراجع Firestore
        // ============================================
        function initializeFirestoreReferences() {
            videoStateRef = db.collection('rooms').doc(currentRoom).collection('state').doc('video');
            chatRef = db.collection('rooms').doc(currentRoom).collection('chat')
                .orderBy('timestamp', 'desc')
                .limit(100);
            historyRef = db.collection('rooms').doc(currentRoom).collection('history')
                .orderBy('addedAt', 'desc')
                .limit(20);
            usersRef = db.collection('rooms').doc(currentRoom).collection('users').doc(currentUser.uid);
            
            // تحديث حالة المستخدم
            updateUserStatus();
            
            // تحديث حالة المستخدم كل 30 ثانية
            setInterval(updateUserStatus, 30000);
        }

        function updateUserStatus() {
            if (usersRef) {
                usersRef.set({
                    uid: currentUser.uid,
                    name: `مستخدم_${currentUser.uid.substring(0, 6)}`,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    online: true,
                    typing: false
                }, { merge: true });
            }
        }

        // ============================================
        // YouTube Player
        // ============================================
        function loadYouTubePlayer() {
            if (window.YT && window.YT.Player) {
                createYouTubePlayer();
            } else {
                window.onYouTubeIframeAPIReady = createYouTubePlayer;
                
                const script = document.createElement('script');
                script.src = 'https://www.youtube.com/iframe_api';
                document.head.appendChild(script);
            }
        }

        function createYouTubePlayer() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'autoplay': 0,
                    'controls': 1,
                    'rel': 0,
                    'showinfo': 0,
                    'modestbranding': 1,
                    'playsinline': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            console.log('YouTube Player جاهز');
            domElements.videoPlaceholder.style.display = 'none';
            
            // تحديث الوقت كل ثانية
            setInterval(updateTimeDisplay, 1000);
            
            // تحميل آخر فيديو تم مشاهدته
            loadLastVideo();
        }

        function onPlayerStateChange(event) {
            if (!player || !videoStateRef || isSyncing) return;
            
            const state = event.data;
            const currentTime = player.getCurrentTime();
            
            // تجاهل بعض الحالات
            if (state === -1 || state === 5) return;
            
            // تحديث زر التشغيل/الإيقاف
            updatePlayPauseButton(state);
            
            // تحديث الحالة في Firestore (إذا تجاوزت الحد الزمني)
            const now = Date.now();
            if (now - lastSyncTime > SYNC_THRESHOLD) {
                updateVideoState({
                    state: state === 1 ? 'playing' : 'paused',
                    currentTime: currentTime,
                    timestamp: now,
                    videoId: currentVideoId
                });
                lastSyncTime = now;
            }
        }

        function onPlayerError(event) {
            console.error('خطأ في مشغل YouTube:', event.data);
            showToast('حدث خطأ في تحميل الفيديو', 'error');
        }

        function updatePlayPauseButton(state) {
            const btn = domElements.playPauseBtn;
            const icon = btn.querySelector('i');
            
            if (state === 1) { // تشغيل
                icon.className = 'fas fa-pause';
                btn.title = 'إيقاف مؤقت';
            } else { // إيقاف
                icon.className = 'fas fa-play';
                btn.title = 'تشغيل';
            }
        }

        // ============================================
        // مزامنة الفيديو
        // ============================================
        function listenToVideoState() {
            videoListener = videoStateRef.onSnapshot((doc) => {
                if (!doc.exists || !player || !player.getCurrentTime) return;
                
                const data = doc.data();
                if (!data || data.updatedBy === currentUser.uid) return;
                
                // تجاهل التحديثات القديمة جداً
                const now = Date.now();
                if (data.timestamp && now - data.timestamp > 5000) return;
                
                // تطبيق حالة المزامنة
                applyVideoState(data);
            }, (error) => {
                console.error('خطأ في الاستماع لتحديثات الفيديو:', error);
            });
        }

        function applyVideoState(state) {
            if (!player || !player.seekTo || isSyncing) return;
            
            isSyncing = true;
            domElements.syncIndicator.style.display = 'flex';
            
            // إذا كان الفيديو مختلفاً، قم بتغييره
            if (state.videoId && state.videoId !== currentVideoId) {
                currentVideoId = state.videoId;
                player.loadVideoById(state.videoId);
                domElements.videoUrl.value = `https://www.youtube.com/watch?v=${state.videoId}`;
            }
            
            // مزامنة الوقت إذا كان الفرق كبيراً
            const currentTime = player.getCurrentTime();
            const timeDifference = Math.abs(currentTime - (state.currentTime || 0));
            
            if (timeDifference > 2) {
                player.seekTo(state.currentTime, true);
            }
            
            // مزامنة حالة التشغيل
            if (state.state === 'playing' && player.getPlayerState() !== 1) {
                player.playVideo();
            } else if (state.state === 'paused' && player.getPlayerState() !== 2) {
                player.pauseVideo();
            }
            
            // إخفاء مؤشر المزامنة بعد تأخير بسيط
            setTimeout(() => {
                isSyncing = false;
                domElements.syncIndicator.style.display = 'none';
            }, 1000);
        }

        function updateVideoState(updates) {
            if (!videoStateRef) return;
            
            videoStateRef.set({
                ...updates,
                updatedBy: currentUser.uid,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).catch((error) => {
                console.error('خطأ في تحديث حالة الفيديو:', error);
            });
        }

        // ============================================
        // إدارة الفيديو
        // ============================================
        function loadVideoFromInput() {
            const url = domElements.videoUrl.value.trim();
            if (!url) {
                showToast('الرجاء إدخال رابط فيديو YouTube', 'warning');
                return;
            }
            
            const videoId = extractYouTubeId(url);
            if (!videoId) {
                showToast('رابط YouTube غير صالح', 'error');
                return;
            }
            
            loadVideo(videoId);
        }

        function extractYouTubeId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/.*[?&]v=([^&#]+)/,
                /youtu\.be\/([^?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        function loadVideo(videoId, startTime = 0) {
            if (!player || !player.loadVideoById) return;
            
            currentVideoId = videoId;
            
            player.loadVideoById({
                videoId: videoId,
                startSeconds: startTime
            });
            
            // تحديث حالة الفيديو
            updateVideoState({
                videoId: videoId,
                currentTime: startTime,
                state: 'paused',
                timestamp: Date.now()
            });
            
            // تحديث رابط الفيديو
            domElements.videoUrl.value = `https://www.youtube.com/watch?v=${videoId}`;
            
            // إخفاء النص البديل
            domElements.videoPlaceholder.style.display = 'none';
            
            // حفظ في السجل
            saveToHistory(videoId);
            
            showToast('تم تحميل الفيديو بنجاح', 'success');
        }

        function loadLastVideo() {
            videoStateRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.videoId) {
                        loadVideo(data.videoId, data.currentTime || 0);
                    }
                }
            });
        }

        // ============================================
        // الدردشة المباشرة
        // ============================================
        function listenToChat() {
            chatListener = chatRef.onSnapshot((snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // عرض الرسائل بترتيب عكسي (الأقدم أولاً)
                displayMessages(messages.reverse());
                
                // تحديث عدد الرسائل
                domElements.messageCount.textContent = messages.length;
                
                // إذا كانت الدردشة مصغرة، أضف إشعاراً
                if (isChatMinimized && messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    if (lastMessage.senderId !== currentUser.uid) {
                        chatUnreadCount++;
                        updateChatNotification();
                    }
                }
            }, (error) => {
                console.error('خطأ في تحميل الدردشة:', error);
            });
        }

        function displayMessages(messages) {
            const chatMessages = domElements.chatMessages;
            chatMessages.innerHTML = '';
            
            if (messages.length === 0) {
                const systemMsg = createSystemMessage('لا توجد رسائل بعد. كن أول من يرسل رسالة!');
                chatMessages.appendChild(systemMsg);
                return;
            }
            
            messages.forEach((message) => {
                const messageElement = createMessageElement(message);
                chatMessages.appendChild(messageElement);
            });
            
            // التمرير لأسفل
            scrollToBottom();
        }

        function createMessageElement(message) {
            const div = document.createElement('div');
            
            if (message.type === 'system') {
                div.className = 'message-system';
                div.innerHTML = `
                    <i class="fas fa-${message.icon || 'info-circle'}"></i>
                    ${message.text}
                `;
                return div;
            }
            
            const isSent = message.senderId === currentUser.uid;
            const time = message.timestamp ? message.timestamp.toDate() : new Date();
            const timeString = time.toLocaleTimeString('ar-EG', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            
            div.className = `message ${isSent ? 'sent' : 'received'}`;
            div.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">${message.senderName || 'مستخدم'}</div>
                    <div class="message-time">${timeString}</div>
                </div>
                <div class="message-text">${message.text}</div>
            `;
            
            return div;
        }

        function createSystemMessage(text, icon = 'info-circle') {
            return createMessageElement({
                type: 'system',
                text: text,
                icon: icon
            });
        }

        function sendMessage() {
            const input = domElements.chatInput;
            const text = input.value.trim();
            
            if (!text || !currentUser) return;
            
            // إضافة الرسالة إلى Firestore
            db.collection('rooms').doc(currentRoom).collection('chat').add({
                text: text,
                senderId: currentUser.uid,
                senderName: `مستخدم_${currentUser.uid.substring(0, 6)}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'message'
            }).then(() => {
                input.value = '';
                input.focus();
                
                // إخفاء مؤشر الكتابة
                if (usersRef) {
                    usersRef.update({ typing: false });
                }
            }).catch((error) => {
                console.error('خطأ في إرسال الرسالة:', error);
                showToast('فشل إرسال الرسالة', 'error');
            });
        }

        function handleTyping() {
            if (!usersRef) return;
            
            // تحديث حالة الكتابة
            usersRef.update({ typing: true });
            
            // إعادة تعيين المؤقت
            clearTimeout(userTypingTimeout);
            userTypingTimeout = setTimeout(() => {
                usersRef.update({ typing: false });
            }, TYPING_TIMEOUT);
        }

        function clearChat() {
            if (!confirm('هل أنت متأكد من رغبتك في مسح جميع رسائل الدردشة؟')) {
                return;
            }
            
            // حذف جميع الرسائل
            db.collection('rooms').doc(currentRoom).collection('chat').get()
                .then((snapshot) => {
                    const batch = db.batch();
                    snapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    showToast('تم مسح الدردشة بنجاح', 'success');
                })
                .catch((error) => {
                    console.error('خطأ في مسح الدردشة:', error);
                    showToast('فشل مسح الدردشة', 'error');
                });
        }

        // ============================================
        // سجل الفيديوهات
        // ============================================
        function loadPartyHistory() {
            historyRef.get().then((snapshot) => {
                const historyGrid = domElements.historyGrid;
                historyGrid.innerHTML = '';
                
                if (snapshot.empty) {
                    historyGrid.innerHTML = `
                        <div class="empty-history">
                            <i class="fas fa-history"></i>
                            <p>لا توجد فيديوهات سابقة</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const video = { id: doc.id, ...doc.data() };
                    addVideoToHistory(video);
                });
            }).catch((error) => {
                console.error('خطأ في تحميل السجل:', error);
            });
        }

        function addVideoToHistory(video) {
            const historyGrid = domElements.historyGrid;
            
            // إزالة الرسالة الفارغة إذا كانت موجودة
            const emptyMsg = historyGrid.querySelector('.empty-history');
            if (emptyMsg) emptyMsg.remove();
            
            const card = document.createElement('div');
            card.className = 'history-card';
            card.dataset.videoId = video.videoId;
            
            card.innerHTML = `
                <img src="https://img.youtube.com/vi/${video.videoId}/hqdefault.jpg" 
                     alt="${video.title || 'فيديو'}" 
                     class="history-thumbnail">
                <div class="history-overlay">
                    <div class="play-overlay">
                        <i class="fas fa-play"></i>
                    </div>
                </div>
                <div class="history-info">
                    <div class="history-title">${video.title || 'فيديو بدون عنوان'}</div>
                    <div class="history-meta">
                        <span>${formatDate(video.addedAt)}</span>
                        <span>${video.addedBy ? video.addedBy.substring(0, 6) : ''}</span>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => {
                loadVideo(video.videoId);
            });
            
            historyGrid.prepend(card);
        }

        function saveToHistory(videoId) {
            // الحصول على معلومات الفيديو
            const title = `فيديو YouTube (${videoId})`;
            
            historyRef.add({
                videoId: videoId,
                title: title,
                addedBy: currentUser.uid,
                addedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                // إعادة تحميل التاريخ
                loadPartyHistory();
            }).catch((error) => {
                console.error('خطأ في حفظ التاريخ:', error);
            });
        }

        function clearHistory() {
            if (!confirm('هل أنت متأكد من رغبتك في مسح سجل الفيديوهات؟')) {
                return;
            }
            
            historyRef.get().then((snapshot) => {
                const batch = db.batch();
                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                return batch.commit();
            }).then(() => {
                showToast('تم مسح السجل بنجاح', 'success');
                loadPartyHistory();
            }).catch((error) => {
                console.error('خطأ في مسح السجل:', error);
                showToast('فشل مسح السجل', 'error');
            });
        }

        // ============================================
        // المستخدمون المتصلون
        // ============================================
        function trackOnlineUsers() {
            // تحديث عدد المستخدمين المتصلين
            db.collection('rooms').doc(currentRoom).collection('users')
                .where('online', '==', true)
                .onSnapshot((snapshot) => {
                    let onlineCount = 0;
                    const now = Date.now();
                    
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        if (user.lastSeen) {
                            const lastSeen = user.lastSeen.toDate().getTime();
                            // يعتبر مستخدم متصل إذا كان آخر ظهوره قبل أقل من دقيقتين
                            if (now - lastSeen < 120000) {
                                onlineCount++;
                            }
                        }
                    });
                    
                    domElements.userCount.textContent = onlineCount;
                });
        }

        // ============================================
        // أدوات مساعدة
        // ============================================
        function togglePlayPause() {
            if (!player) return;
            
            const state = player.getPlayerState();
            if (state === 1) { // تشغيل
                player.pauseVideo();
            } else { // إيقاف
                player.playVideo();
            }
        }

        function toggleFullscreen() {
            const container = document.querySelector('.video-container');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch((err) => {
                    console.error(`خطأ في تفعيل ملء الشاشة: ${err.message}`);
                });
                document.body.classList.add('fullscreen-video');
                isFullscreen = true;
            } else {
                document.exitFullscreen();
                document.body.classList.remove('fullscreen-video');
                isFullscreen = false;
            }
        }

        function toggleTheaterMode() {
            isTheaterMode = !isTheaterMode;
            document.body.classList.toggle('theater-mode', isTheaterMode);
            
            const btn = domElements.theaterBtn;
            if (isTheaterMode) {
                btn.classList.add('active');
                btn.title = 'خروج من وضع المسرح';
            } else {
                btn.classList.remove('active');
                btn.title = 'وضع المسرح';
            }
        }

        function toggleChat() {
            isChatMinimized = !isChatMinimized;
            const chatSection = domElements.chatSection;
            const toggleIcon = domElements.chatToggle.querySelector('i');
            
            if (isChatMinimized) {
                chatSection.classList.add('minimized');
                toggleIcon.className = 'fas fa-chevron-left';
                
                // إضافة أيقونة مصغرة
                if (!document.getElementById('minimizedChatIcon')) {
                    const icon = document.createElement('div');
                    icon.id = 'minimizedChatIcon';
                    icon.className = 'chat-minimized-icon';
                    icon.innerHTML = '<i class="fas fa-comment"></i>';
                    icon.addEventListener('click', toggleChat);
                    chatSection.appendChild(icon);
                }
                
                updateChatNotification();
            } else {
                chatSection.classList.remove('minimized');
                toggleIcon.className = 'fas fa-chevron-right';
                
                // إزالة الأيقونة المصغرة
                const icon = document.getElementById('minimizedChatIcon');
                if (icon) icon.remove();
                
                // إعادة تعيين العداد
                chatUnreadCount = 0;
            }
        }

        function updateChatNotification() {
            const icon = document.getElementById('minimizedChatIcon');
            if (!icon) return;
            
            // إزالة أي إشعارات سابقة
            const oldBadge = icon.querySelector('.notification-badge');
            if (oldBadge) oldBadge.remove();
            
            // إضافة إشعار جديد إذا كان هناك رسائل غير مقروءة
            if (chatUnreadCount > 0) {
                const badge = document.createElement('div');
                badge.className = 'notification-badge';
                badge.textContent = chatUnreadCount > 9 ? '9+' : chatUnreadCount;
                icon.appendChild(badge);
            }
        }

        function updateTimeDisplay() {
            if (!player || !player.getCurrentTime) return;
            
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            
            domElements.currentTime.textContent = formatTime(currentTime);
            domElements.duration.textContent = formatTime(duration);
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'قبل فترة';
            
            const date = timestamp.toDate();
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'الآن';
            if (diffMins < 60) return `قبل ${diffMins} دقيقة`;
            if (diffMins < 1440) return `قبل ${Math.floor(diffMins / 60)} ساعة`;
            return `قبل ${Math.floor(diffMins / 1440)} يوم`;
        }

        function scrollToBottom() {
            const chatMessages = domElements.chatMessages;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function inviteFriends() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showToast('تم نسخ رابط الدعوة إلى الحافظة', 'success');
            }).catch(() => {
                prompt('انسخ الرابط التالي ودعو أصدقاءك:', url);
            });
        }

        function showSettings() {
            showToast('قريباً: إعدادات التطبيق', 'info');
        }

        function handleFullscreenChange() {
            isFullscreen = !!document.fullscreenElement;
            document.body.classList.toggle('fullscreen-video', isFullscreen);
        }

        function handleKeyPress(e) {
            // تجاهل إذا كان المستخدم يكتب في حقل نصي
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.code) {
                case 'Space':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 'KeyF':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
                case 'KeyT':
                    e.preventDefault();
                    toggleTheaterMode();
                    break;
                case 'KeyM':
                    e.preventDefault();
                    toggleChat();
                    break;
            }
        }

        function handleBeforeUnload() {
            // تحديث حالة المستخدم عند المغادرة
            if (usersRef) {
                usersRef.update({ 
                    online: false,
                    typing: false 
                });
            }
        }

        // ============================================
        // بدء التطبيق
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            // عرض شاشة الترحيب تلقائياً
            // يمكنك إزالة هذا السطر إذا أردت بدء التطبيق مباشرة
            domElements.welcomeModal.style.display = 'flex';
        });
    </script>
</body>
</html>